<!doctype html>
<html>
<head><meta charset='utf-8'><title>Payments</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light p-4">
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Payments</h2>
    <a class="btn btn-primary" href="#">Dashboard</a>
  </div>
  <div class="row">
    <div class="col-md-6">
      <div class="card p-3 mb-3">
        <h5>Record Payment</h5>
        <form method="post" action="{% url 'create_payment' %}">{% csrf_token %}
          <div class="mb-2"><label>Student ID</label><input class="form-control" name="student_id" required></div>
          <div class="mb-2"><label>Type</label><select class="form-select" name="payment_type">{% for k,v in form.fields.payment_type.choices %}<option value="{{k}}">{{v}}</option>{% endfor %}</select></div>
          <div class="mb-2"><label>Amount</label><input class="form-control" name="amount" type="number" step="0.01" required></div>
          <div class="mb-2"><label>Method</label><input class="form-control" name="method"></div>
          <div class="mb-2"><label>Note</label><textarea class="form-control" name="note"></textarea></div>
          <button class="btn btn-success w-100">Submit</button>
        </form>
      </div>
      <div class="card p-3">
        <h6>Recent Payments</h6>
        <table class="table table-sm">
          <thead><tr><th>Student</th><th>Type</th><th>Amount</th><th>Date</th></tr></thead>
          <tbody>{% for p in payments %}<tr><td>{{p.student}}</td><td>{{p.payment_type}}</td><td>{{p.amount}}</td><td>{{p.payment_date}}</td></tr>{% empty %}<tr><td colspan=4>No payments</td></tr>{% endfor %}</tbody>
        </table>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h5>Real-time Summary</h5>
        <h3 id="total">₹0</h3>
        <canvas id="statusChart" style="height:250px"></canvas>
        <h6 class="mt-3">Recent</h6>
        <ul id="recent"></ul>
      </div>
    </div>
  </div>
</div>
<script>
async function fetchData(){
  const r = await fetch('{% url "dashboard_data" %}', {credentials:'same-origin'});
  const j = await r.json();
  document.getElementById('total').textContent = '₹' + j.total.toFixed(2);
  const labels = j.by_status.map(x=>x.status);
  const data = j.by_status.map(x=>x.count);
  const ctx = document.getElementById('statusChart');
  if(window._chart) window._chart.destroy();
  window._chart = new Chart(ctx, {type:'doughnut', data:{labels:labels, datasets:[{data:data}]}});
  const recent = document.getElementById('recent'); recent.innerHTML='';
  j.recent.forEach(r=>{ const li=document.createElement('li'); li.textContent = r.student__name + ' ' + r.payment_type + ' ₹' + r.amount; recent.appendChild(li); });
}
fetchData(); setInterval(fetchData,5000);
</script>
</body>
</html>
